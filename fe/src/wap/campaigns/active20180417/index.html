<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="format-detection" content="telphone=no, email=no"/>
    <title>积分抽奖活动</title>
    <link rel="stylesheet" href="../../common/css/wenjfbase.css">
    <link rel="stylesheet" href="css/gifts-list.css">
    <link rel="stylesheet" href="css/index.min.css?v=1.3">
    <script src="../../libs/lib.flexible3.js"></script>
    <script src="../../libs/vue.min.js"></script>
    <script src="../../libs/jquery-1.11.1.min.js"></script>
    <script src="../../libs/iscroll.js"></script>
    <script src="../../libs/handlebars-v4.0.10.js"></script>
    <script src="../../libs/fastclick.js"></script>
    <script src="js/gifts-list.js"></script>
</head>
<body>
<div class="flex-content" id="active">
    <div class="banner">
        <img src="images/banner.png" alt="">
        <dl class="clearfix">
            <dt class="lf">我的积分：<a :href="url"><strong v-cloak>{{points}}</strong></a></dt>
            <dd @click="giftList" class="rg">奖品列表></dd>
        </dl>
    </div>
    <div class="draw-bg" id="prz_pool">
        <table class="clearfix" id="prize_pool">
            <tr>
                <td class="lf lottery-unit-1 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_01.png" alt="">
                        <p>意大利公鸡头皂</p>
                    </div>
                    <div class="bottom"></div>
                </td>
                <td class="lf lottery-unit-2 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_02.png" alt="">
                        <p>天堂伞</p>
                    </div>
                    <div class="bottom"></div>
                </td>
                <td class="lf lottery-unit-3 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_03.png" alt="">
                        <p>50元超市卡</p>
                    </div>
                    <div class="bottom"></div>
                </td>
            </tr>
            <tr>
                <td class="lf lottery-unit-8 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_08.png" alt="">
                        <p>小米恒温电水壶</p>
                    </div>
                    <div class="bottom"></div>
                </td>
                <td class="lf lottery-unit"><img @click="draw" id="draw" data-click="true" src="images/btn.png" alt="">
                </td>
                <td class="lf lottery-unit-4 lottery-unit mg" style="margin-left: 0.15rem">
                    <div class="top">
                        <img src="images/gifts_04.png" alt="">
                        <p>五谷杂粮礼盒</p>
                    </div>
                    <div class="bottom"></div>
                </td>
            </tr>
            <tr>
                <td class="lf lottery-unit-7 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_07.png" alt="">
                        <p>200积分</p>
                    </div>
                    <div class="bottom"></div>
                </td>
                <td class="lf lottery-unit-6 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_06.png" alt="">
                        <p>20元代金券</p>
                    </div>
                    <div class="bottom"></div>
                </td>
                <td class="lf lottery-unit-5 lottery-unit mg">
                    <div class="top">
                        <img src="images/gifts_05.png" alt="">
                        <p>维达抽纸6连包</p>
                    </div>
                    <div class="bottom"></div>
                </td>
            </tr>
        </table>
    </div>
    <div class="regular">
        <p class="get-more">积分不足?点击 <a href="/deal/deal/index">立即投资</a></p>
        <div class="title">活动规则</div>
        <div class="list">
            <p>活动时间2018年4月23日-4月28日；</p>
            <p>点击“立即抽奖”，积分将立即扣除，同时获得1件随机奖品；</p>
            <p>每次抽奖需消耗<i class="special">200</i>积分，积分可通过投资、签到等赚取；</p>
            <p>已消耗的积分不可退回；</p>
            <p>代金券、积分等虚拟奖品将立即到账，请至账户中心查看；</p>
            <p>抽到实物奖品的客户，客服会在3个工作日内联系您确认领奖事宜，请保持通信畅通。</p>
        </div>
        <div class="tips">
            本次活动最终解释权归温都金服所有<br>
            理财非存款 产品有风险 投资须谨慎
        </div>
    </div>

    <!--中奖弹框-->
    <div v-show="isClose" class="mask" v-cloak>
        <div class="pop">
            <img @click="closePop" class="close" src="images/close.png" alt="">
            <p>意大利公鸡头皂</p>
            <img class="gift" src="images/gifts_02.png" alt="">
            <img class="pop-img" src="images/pop.png" alt="">
            <img @click="closePop" class="confirm" src="images/confirm.png" alt="">
        </div>
    </div>
    
    <!--isDraw-->
    <div class="mask">
        <div class="pop">
            <img class="is-draw" src="images/isdraw.png" alt="">
            <img class="close-special" src="images/close.png" alt="">
            <div class="btn confirm-special">是</div>
            <div class="btn cancel">否</div>
        </div>
    </div>
</div>
<script>
    $(function () {
        FastClick.attach(document.body);
        $("img").on("click",function(event){
            var event = event || window.event;
            event.preventDefault();
        });
        //抽奖配置代码
        var lottery = {
            index: -1,	//当前转动到哪个位置，起点位置
            count: 0,	//总共有多少个位置
            timer: 0,	//setTimeout的ID，用clearTimeout清除
            speed: 100,	//初始转动速度
            times: 0,	//转动次数
            cycle: 30,	//转动基本次数：即至少需要转动多少次再进入抽奖环节
            prize: -1,	//中奖位置
            jiangpin: 0,
            init: function (id) {
                if ($("#" + id).find(".lottery-unit").length > 0) {
                    $lottery = $("#" + id);
                    $units = $lottery.find(".lottery-unit");
                    this.obj = $lottery;
                    this.count = $units.length;
                }
            },
            roll: function () {
                var index = this.index;
                var count = this.count;
                var lottery = this.obj;
                $(lottery).find(".lottery-unit-" + index + " .top").removeClass("active-top");
                $(lottery).find(".lottery-unit-" + index + " .bottom").removeClass("active-bottom");
                index += 1;
                if (index > count - 1) {
                    index = 0;
                }
                $(lottery).find(".lottery-unit-" + index + " .top").addClass("active-top");
                $(lottery).find(".lottery-unit-" + index + " .bottom").addClass("active-bottom");
                this.index = index;
                return false;
            },
            stop: function (index) {
                this.prize = index;
                return false;
            }
        };
        function roll() {
            if (lottery.times > lottery.cycle + 5 && lottery.prize == lottery.index) {
                clearTimeout(lottery.timer);
                lottery.prize = -1;
                lottery.times = 0;
                setTimeout(active.award, 800);
            } else {
                if (lottery.times < lottery.cycle) {
                    lottery.speed -= 10;
                } else if (lottery.times == lottery.cycle) {
                    var index = lottery.jiangpin;
                    lottery.prize = index; //此处定义最后是哪个奖品，可通过给lottery.jiangpin赋值改变
                } else {
                    if (lottery.times > lottery.cycle + 10 && ((lottery.prize == 0 && lottery.index == 5) || lottery.prize == lottery.index + 4)) {
                        lottery.speed += 110;
                    } else {
                        lottery.speed += 20;
                    }
                }
                if (lottery.speed < 65) {
                    lottery.speed = 65;
                }
                lottery.timer = setTimeout(roll, lottery.speed);
            }
            lottery.times += 1;
            lottery.roll();
        }
        var active = new Vue({
            el: "#active",
            data: {
                promoStatus: 0,
                isLogin: true,
                url: "javascript:void(0);",
                points: '',
                isClose: false,
            },
            created: function () {
                this.points = this.isLogin ? "500分" : "未登录";
                if (!this.isLogin) {
                    this.url = "/site/login"
                }
            },
            methods: {
                draw: function () {
                    var status = this.baseVerify();
                    if ($("#draw").data("click") && status) {
                        //初始化抽奖部分
                        lottery.init('prz_pool');
                        $("#draw").data("click",false);
                        //调用接口 改变lottery.jiangpin来决定最终哪个奖品 改变award函数来决定函数的回掉
                        lottery.speed = 90;
                        //这里设置中的奖品
                        lottery.jiangpin = 6;
                        roll();
                        return false;
                    }
                },
                award:function(){
                    this.isClose = !this.isClose
                    $("#draw").data("click",true);
                },
                closePop: function () {
                    this.isClose = !this.isClose
                },
                giftList: function () {
                    var _this = this;
                    var status;
                    switch (_this.promoStatus) {
                        case 0:
                            if (_this.isLogin) {
                                status = true;
                            } else {
                                window.location.href = "/site/login";
                            }
                            break;
                        case 1:
                            _this.toastCenter('活动未开始');
                            break;
                        case 2:
                            status = true;
                            break;
                        default:
                            break;
                    }
                    if(status){
                        $.ajax({
                            type: "GET",
                            url: "/promotion/p180423/award-list",
                            data: "{key:promo_180423}",
                            success: function (data) {
                                if (data.code === 0 && data.result.length != 0) {
                                    giftsList({
                                        isGifts: true,//有奖品，无奖品为false
                                        closeImg: 'images/close.png',
                                        list: data.result
                                    });
                                } else if (data.code === 0 && data.result.length === 0) {
                                    giftsList({
                                        isGifts: false,//无奖品为false
                                        closeImg: 'images/close.png',
                                        list: []
                                    });
                                } else {
                                    _this.toastCenter(data.message);
                                }
                            },
                            error: function (error) {
                                _this.toastCenter(error)
                            }
                        })
                    }
                },
                baseVerify: function () {
                    var _this = this;
                    switch (_this.promoStatus) {
                        case 0:
                            if (_this.isLogin) {
                                return true;
                            } else {
                                window.location.href = "/site/login";
                                return false;
                            }
                            break;
                        case 1:
                            _this.toastCenter('活动未开始');
                            return false;
                            break;
                        case 2:
                            _this.toastCenter('活动已结束');
                            return false;
                            break;
                        default:
                            break;
                    }
                },
                toastCenter: function (val, active) {
                    var $alert = $('<div class="error-info" style="display: block; position: fixed;font-size: .4rem;"><div>' + val + '</div></div>');
                    $('body').append($alert);
                    $alert.find('div').width($alert.width());
                    setTimeout(function () {
                        $alert.fadeOut();
                        setTimeout(function () {
                            $alert.remove();
                        }, 200);
                        if (active) {
                            active();
                        }
                    }, 2000);
                },
            }
        });
    });
</script>
</body>
</html>