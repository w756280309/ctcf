# 债权转让

> todo 整理中

定义
1. 交易系统，TX项目，数据库是tx，目前交易系统包含转让所有逻辑
2. TX_HOST，交易系统域名
3. 资产，用户所持有的资产，可以是购买标的得到的标的订单，也可以是购买转让得到的转让订单

> 如无特殊说明，以下所有链接都以 WAP端 为准，逻辑也都是以wap端为准（主要逻辑都在交易系统中，所有客户端都是一样的；PC端和WAP端主要负责页面展示及接口调用）

## 可转让列表

- 地址：/credit/trade/assets?type=1
- 进入条件：登录用户
- 分页数：5
- 直接请求交易系统获取可转让列表数据

### 交易系统可转让列表接口

- 地址 TX_HOST/Api/assets/transferable-list
- 参数
| 参数名 | 是否必要 | 类型 | 默认值 | 含义|
|--------|----------|------|--------|-----|
|user_id|Y|int|| 用户在温都系统user表id|
|offset|N|int|0|查询偏移量|
|limit|N|int|10|查询每页条数|
- 返回值

```
return [
    'limit' => $limit,//实际查询每页条数
    'offset' => $offset,//实际查询偏移量
    'totalCount' => $totalCount,//查询记录总条数
    'creditAmount' => $creditAmount,//可转让金额总和
    'data' => $data,//可转让列表
];
```

- 主要筛选表 user_asset
- 筛选条件
 - user_id = 当前用户ID(用户)
 - && isPepaid = false(没有还款)
 - && amount > 0(资产金额)
- 过滤
 - 循环初步筛选结果，对每条记录调用 $asset->canBuildCredit()进行进一步过滤
 
### $asset->canBuildCredit() 逻辑

有此方法的详细测试用例,TX/tests/codeception/src/Model/UserAssetTest.php
主要判断条件：
- 找到原始标的，标的状态为收益中($loan->status = 5)
- 当前日期小于标的截止日期
- 资产的转让次数小于配置文件中的最大转让次数($asset->tradeCount < $config['trade_count_limit'])
- 时间验证
 - 分期项目小于等于 $config['loan_fenqi_limit'] 个月不能转让 
 - 到期本息项目小于等于 $config['loan_daoqi_limit'] 天不能转让
 - 转让时间（默认取当前时间）大于等于资产开始时间（普通资产开始时间为标的计息时间，多次转让时候，开始时间为新建资产的后一天 ）
 - 转让时间不能大于下一个还款日
 - 最低持有 $config['holdDays'] 天(用转让时间和资产开始时间比)
 - 下一个还款日前 $config['duration'] 天不能转让
- 资金验证
 - 转让金额(默认取资产可转让金额)不能超过资产可转让金额
 - 转让金额必须大于起投金额(取标的的起头金额)
 - 转让完成之后，剩余可转让金额不足起头金额，必须将剩余金额同时全部转让
 - 转让金额必须以递增金额（标的的递增金额）的整数倍递增

## 发起转让页面

- 地址：/credit/note/new?asset_id=1129
- 进入条件
 - 登录用户
 - 请求交易系统，获取资产详情 TX_HOST/Api/assets/detail (当validate参数为true时候 调用$asset->canBuildCredit())

 - 资产所属标的存在，且标的是收益中
 - 资产原始订单存在
 - 判断资产所有者和当前登录用户是同一个用户
- 页面转让金额、折让率判断效果
 - 当触发JS的change()事件时候执行判断函数
 - js做基本验证之后请求交易系统做金额验证（TX_HOST/credit-note/calc）
- 表单验证及提交

## 发起转让表单处理

- 地址：/credit/note/create
- 接口文档 todo
- 判断条件
 - 登录用户
 - 资产存在
 - 资产所有者是当前登录用户
 - 请求交易系统发起转让 TX_HOST/Api/credit-note/new
 
### 交易系统发起转让接口

- 地址：TX_HOST/Api/credit-note/new
- 参数：
| 参数名 | 是否必要 | 类型 | 默认值 | 含义|
|--------|----------|------|--------|-----|
|asset_id|Y|int|| 用户在温都系统user_asset表id|
|amount|Y|int|0|转让金额，以分为单位|
|discountRate|N|float|0|转让折让率|
- 返回：
 - 失败返回错误信息
 - 成功不返回
- 判断条件：
 - 找到资产，资产未完成还款($asset->isRepaid !== true)
 - 找到标的，标的是收益中
- 操作结果
 - 新建一条 credit_note 记录,将 $defaultConfig 信息保存到$note->config
 - 更新 user_asset 的 maxTradableAmount(最大可转让金额)

## 转让中列表

- 地址：/credit/trade/assets?type=2
- 进入条件：登录用户
- 分页条数：5
- 获取转让统计数
- 获取转让列表

### 获取用户转让中或已转让挂牌记录统计数据.

- 地址：TX_HOST/APi/credit-note/user-notes-stats
- 参数：
| 参数名 | 是否必要 | 类型 | 默认值 | 含义|
|--------|----------|------|--------|-----|
|type|N|int|2|列表类型,2:转让中，3：已转让|
|user_id|Y|int||用户在温都系统user表ID|
- 返回：

```
 return [
        'type' => $type,//列表类型
        'totalCount' => $totalCount,//总记录数
        'tradedTotalAmount' => $tradedTotalAmount,//已转让总金额
        'tradingTotalAmount' => $tradingTotalAmount,//待转让总金额
    ];
```

### 获取用户所有转让中或已转让的挂牌记录.

- 地址 TX_HOST/Api/credit-note/user-notes
- 参数
| 参数名 | 是否必要 | 类型 | 默认值 | 含义|
|--------|----------|------|--------|-----|
|type|N|int|2|列表类型,2:转让中，3：已转让|
|user_id|Y|int||用户在温都系统user表ID|
|offset|N|int|0|查询偏移量|
|limit|N|int|10|每页查询条数|
- 返回

```
return [
        'offset' => $offset,//实际查询偏移量
        'limit' => $limit,//实际查询分页大小
        'data' => $notes,//转让组成的数组
    ];
```

## 转让详情页

地址:/credit/note/detail?id=103
进入条件：转让开户、白名单
获取转让详情

### 获取转让详情

- 地址： TX_HOST/Api/credit-note/detail
- 参数：
| 参数名 | 是否必要 | 类型 | 默认值 | 含义|
|--------|----------|------|--------|-----|
|id|Y|int||交易系统转让credit_note表ID|
|isLong|N|bool|false|是否获取转让的预期收益和应付利息|


- 返回：转让信息 加 remainingInterest(预期收益) currentInterest(应付利息)
- 计算购买方应付利息 
 - 应付利息的日期 = 当天 + 1 - 上个还款日|计息日 
 - 应付利息 = 应付利息的日期 × 当期利息 / 当期天数 
- 计算预期剩余收益
 - 预期收益的日期 = 截止日 - 1 - 当天
 - 剩余预期收益 = 剩余总利息 - 应付利息

## 转让购买页

- 地址：/credit/order/order?note_id=103
- 请求交易系统,获取转让信息
- 输入投资金额，请求交易系统计算应付利息、预期收益、实付金额

## 新建订单

- 地址:/credit/order/new
- 判断是否可以购买 `(new CreditNote)->check($noteId, $principal, $user) `
 - 当前转让不存在,原始项目不存在
 - 投资金额不能为空
 - 金额格式错误
 - 获取转让信息
 - 转让已结束 `($nowTime >= $note['endTime'] || $note['isClosed'] || $note['isCancelled'])`
 - 您不能购买自己的转让项目
 - 您的可用余额不足
 - 投资金额不能超过可交易金额
 - 投资金额小于起投金额`$minAmountYuan`(从$note->config获取)元
 - 递增整数倍
 - 购买后可投余额不可低于起投金额
 - 最后一笔需要投满转让
- 请求交易系统，新建订单

### 新建订单接口

- 地址：TX_HOST/Api/credit-order/new
- 参数
| 参数名 | 是否必要 | 类型 | 默认值 | 含义|
|--------|----------|------|--------|-----|
|user_id|Y|int||温都金服user表ID|
|note_id|Y|int||tx系统credit_note表ID|
|principal|Y|int|购买本金,以分为单位|

- 返回

```
return ['id' => $order->id];
```

- 计算应付利息 `FinUtils::calculateCurrentProfit($loan, $requestData['principal'], $order->apr)`
- 计算实际支付金额 `bcmul(bcadd($requestData['principal'], $interest, 14), bcsub(1, bcdiv($note->discountRate, 100, 14), 14), 0)`
- 计算手续费 `bcmul($requestData['principal'], $config['fee_rate'], 0)`
- 新建 credit_order , status
- 验证订单 `$order->validateOrder()`
 - ` FinUtils::canBuildCreditByAmount($noteTradeableAmount, $this->principal, $config['min_order_amount'], $config['incr_order_amount'])`
 - 金额必须是大于零
 - 金额不能超过可转让金额
 - 金额必须大于起投金额($note->config中取值)
 - 金额必须以递增金额的整数倍递增
 - 将剩余金额全部转让


###  订单相关逻辑

> 当时任务时间紧急，温都金服所有数据库操作都集中到一起，使用一个事务管理；交易系统的数据库操作集中到一起，使用一个事务管理。

- 地址：定时任务，命令　php yii crdit-order/confirm
- 每次处理数量：10条
- 处理条件：初始状态的订单
- 每一步订单状态变化会有详细文件日志
- 转让超投判断，如果超投订单直接改为失败，`$note->tradedAmount + $order->principal <= $note->amount`
- 如果买方没有支付，进行支付操作 `if($order->buyerPaymentStatus = 0){dealOrderPay($umpClient, $order)}`
- 买方支付逻辑
 - 订单是初始状态、处理中状态（可能会中途某一步订单逻辑失败，订单变成处理中状态）
 - 请求联动，买方支付　`$order->amount`(本金＋应付利息)
 - 支付成功（联动返回,ret_code='0000'）,` 更新$order->buyerPaymentStatus = 1`
 - 支付失败(ret_code='00240000') ,更新`$order->buyerPaymentStatus = 2`,订单状态直接改为失败
 - 支付异常,更新`$order->buyerPaymentStatus = 3`，将订单状态改为异常（会有单独定时任务处理异常订单）
- 买方支付完成　且　卖方为开始支付　时候, 进行数据库操作　`($order->status ＝　初始状态　|| $order->status ＝　处理中) && $order->buyerPaymentStatus = 1 && $order->sellerRefundStatus = 0`
- 更新交易系统数据
 - 增量更新资产的jinx `$asset->amount = $asset->amount - $order->principal`
 - 添加新资产
```
　 $newAsset->setAttributes([
        'user_id' => $order->user_id,//资产所属用户ＩＤ
        'loan_id' => $asset->loan_id,//资产原始标的ＩＤ
        'order_id' => $asset->order_id,//原始订单ＩＤ
        'asset_id' => $asset->id,//上一级资产ＩＤ
        'note_id' => $order->note_id,//被购买转让的ｉｄ
        'amount' => $order->principal,//新资产的金额
        'orderTime' => $order->createTime,
        'tradeCount' => $asset->tradeCount + 1,//资产被转让次数（购买普通标的产生的资产，tradeCount = 0）
        'maxTradableAmount' => $order->principal,//资产的最大可转让金额
        'isTest' => $asset->isTest,
        'credit_order_id' => $order->id,//记录通过那个转让订单生成的资产
    ], false);
        
```
- 更新交易系统的转让数据
  - 更新转让已转让金额　`$note->tradedAmount += $order->principal`
  - 如果转让已被卖完，关闭转让　`if($note->tradedAmount = $note->amount){$note->isClosed = true}`
 
- 更新温都数据库(金额都是已元为单位)
 - 更新买方账户信息(可用余额,理财资产)　`$userAccount->available_balance -= $amount;$userAccount->investment_balance -= $amount;`
 - 添加买方付款资金流水 `$moneyRecord->osn = $order->id;$moneyRecord->type = 106`
 - 更改卖方账户信息(可用余额，累计收益,理财资产)　`available_balance += $amount;profit_balance += $interest;investment_balance -= $principal`
 - 添加卖方收款流水  `$moneyRecord->osn = $order->id;$moneyRecord->type = 108`
 - 更改卖方账户信息（手续费,更新可用余额） `available_balance -= $fee`
 - 添加卖方手续费流水 `$moneyRecord->osn = $order->id;$moneyRecord->type = 107;`
- 更新温都还款计划（原资产未被卖完）
 - 找出卖方资产 对应的 *还款时间大于转让订单时间* 的所有还款计划，默认还款是严格按照还款日去还款，没到还款时间的还款计划都是未还款。
 - 计算出待还款的卖方还款计划总数
 - 根据订单计算出新的还款计划　`$loan->getRepaymentPlan($order->principal, $loanOrder->apr)`
 - 删除新还款计划中 *还款时间小于等于订单时间* 的还款计划
 - 比较原未还款的还款计划总期数　和　新生成还款计划总期数,保证期数一致
 - 新还款计划的最后一起利息　＝　新还款计划总利息　- 前面几期利息之后
 - 记录新还款计划是哪个转让资产的`$newRepayment->asset_id = $newAsset->id`
 - 更新原还款计划的本金和利息
- 更新温都还款计划(原资产被卖完)
 - 直接将原资产的还款计划的所有者改为购买者
 - 更新 `$newRepayment->asset_id = $newAsset->id;`
 - 当原资产全部卖出时，标记改资产为　已回款 ` $asset->isInvalid = true`
- 当数据库修改完成且卖方未回款时候，执行卖方回款
 - 执行条件：订单处于初始状态或进行中状态　并且　订单已完成买方付款　并且　卖方为回款或回款失败
 - 请求联动，卖方回款，记录日志
 - 联动返回成功，更新　`$order->sellerRefundStatus = 1`
 - 联动返回失败，更新　`$order->sellerRefundStatus = 2`
 - 支付异常，将订单改为处理中（由异常订单机制处理）
- 执行手续费扣除
 - 请求联动，扣除手续费
- //todo 债权订单成功之后添加保全合同队列
- //todo 订单成功后更新当前购买人与转让人的持有数量
- //todo 向温都金服发送转让成功消息，用于promo1212发红包
 

　
   


